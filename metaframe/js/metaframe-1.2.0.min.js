function metaframe_embed_comments(){function a(){var a='<h2 class="mf-comments-header">Comments</h2>';return d&&(a+='<form method="post" id="metaframe-form" class="mf-comment-form"><div id="metaframe-form-error"></div><input id="metaframe-user" type="text" placeholder="Name" /><textarea id="metaframe-comment" placeholder="Comment"></textarea><input type="submit" value="Submit" /><span class="shift-enter-submit">Press Shift + Enter to Submit</span></form>'),a+='<div class="mf-comments"></div>'}function b(){setTimeout(function(){for(var a=f.get(),b=0;b<a.length;b++)console.log(b),a[b]='"'+a[b].join('","')+'"',a[b].replace(/\<br\/\>/g,"\n");var c=a.join("\n");window.location.href="data:text/csv,"+encodeURIComponent(c)},1e3)}var c=$('meta[name="metaframe-csv"]').attr("content"),d=$('meta[name="metaframe-form"]').attr("content"),e=[];if(void 0!==d||void 0!==c){void 0===c&&(c="comments.csv"),$(".notes").append(a()),sessionStorage.getItem("metaframe_user");var f=metaframe_comments_handler({csv_filename:c,form_action:d,external_comments:e});$(".mf-comment-form").on("submit",metaframe_submit({comments_handler:f,csv_filename:c,form_action:d})),$(".mf-comment-form").on("keypress",function(){13==event.keyCode&&event.shiftKey&&$(this).trigger("submit")}),f.load(),setInterval(f.load,6e5),"#downloadcomments"===window.location.hash&&b()}}function metaframe_submit(a){var b=a;return function(a){a.preventDefault();var c={},d=!1,e=$("#metaframe-form"),f=$("#metaframe-user"),g=$("#metaframe-comment");if(c.user=encodeURIComponent(f.val()),c.comment=encodeURIComponent(g.val()),""===c.user||""===c.comment?(d="Please fill in all fields.",e.addClass("error")):e.removeClass("error"),d)return $("#metaframe-form-error").html(d),void 0;$("#metaframe-form-error").html(""),$("#metaframe-user").val(""),$("#metaframe-user").focus(),$("#metaframe-comment").val("");var h=new Date;now_minutes=h.getMinutes(),10>now_minutes&&(now_minutes="0"+now_minutes),c.timestamp=h.getMonth()+1+"/"+h.getDate()+"/"+h.getFullYear()+" "+h.getHours()+":"+now_minutes+" GMT"+h.getTimezoneOffset()/60*-1,c.page=window.location.pathname,c.csv_filename=b.csv_filename,b.comments_handler.add(c),$.ajax({url:b.form_action,type:"POST",data:c}).done(function(){sessionStorage.setItem("metaframe_user",c.user)})}}function metaframe_comments_handler(a){function b(a,b){var c=/^"|"?/g,d=/\n/g,e=a.replace(c,"");return e=decodeURIComponent(e),b===l.column_key.comment&&(e=e.replace(d,"<br/>")),e}function c(a,d){d=d||0;var e=[];return d>=a.length?e:(e.push(b(a[d],d)),e.concat(c(a,d+1)))}function d(a){var b=e(a);return b.length>0?!0:!1}function e(a,b){b=b||0;var c=[];return b>=k.length?c:(a.join(",")==k[b].join(",")&&c.push(a),c.concat(e(a,b+1)))}function f(a,b){b=b||0;var e=[];if(b>=a.length)return e;var g=a[b];return g=g.split('","'),g.length<=1?e:(g=c(g),d(g)||g[l.column_key.page]!=window.location.pathname||e.push(g),e.concat(f(a,b+1)))}function g(a,b){b=b||0;var c=[];if(b>=a.length)return c;var d=document.createElement("div");return d=$(d),d.addClass("metaframe_new_comment"),d.html('<span class="mf-comment">'+a[b][l.column_key.comment]+'</span><span class="mf-comment-user">'+a[b][l.column_key.user]+'</span><span class="mf-comment-timestamp">'+a[b][l.column_key.timestamp]+"</span>"),c.push(d),c.concat(g(a,b+1))}function h(a,b){return b=b||0,console.log("showing comment "+b),b>=a.length?void 0:(a[b].prependTo(".mf-comments"),h(a,b+1))}function i(a){var b=g(a);h(b)}function j(a){console.log("drawing");var b=a.split("\n"),c=f(b);i(c),k=k.concat(c)}var k=[],l=a;return l.column_key={comment:0,user:1,timestamp:2,page:3,spacer:4},{load:function(){$.ajax({url:l.csv_filename,contentType:"text/csv"}).done(j)},get:function(){return k},add:function(a){var b=[a.comment,a.user,a.timestamp,a.page];k.push(b),i([c(b)])}}}$(document).ready(function(){function a(){$(".notes-anchor, .notes-tab").click(function(a){a.preventDefault(),$(".notes-tab").hasClass("open")?($(".notes").animate({right:"-330px"},300),$(".notes-tab").animate({right:"10px"},300),$(".notes-tab").removeClass("open")):($(".notes").animate({right:"0px"},300),$(".notes-tab").animate({right:"340px"},300),$(".notes-tab").addClass("open"))})}function b(){$(".notes-anchor, .notes-tab").click(function(a){a.preventDefault(),$(".notes-tab").hasClass("open")?($(".notes").animate({bottom:"-330px"},300),$(".notes-tab").animate({bottom:"10px"},300),$(".notes-tab").removeClass("open")):($(".notes").animate({bottom:"0px"},300),$(".notes-tab").animate({bottom:"340px"},300),$(".notes-tab").addClass("open"))})}$("<a/>",{"class":"notes-tab",href:"#"}).appendTo("body"),$("<div/>",{"class":"notes Scrollable"}).appendTo("body");var c=$(this).attr("title");$(".notes").html("<h1>"+c+"</h1>");var d=['<form><input type="checkbox" id="noteBox" checked="checked" >show note markers</form>',"<h2>Page Notes</h2>"];$(d.join("")).appendTo(".notes");for(var e=0,f=$(".notation").map(function(){return e++,$(this).attr("note")}),g=0;e-0>g;g++)$(".notes").append('<div class="note-holder"><span class="note-count">'+(g+1)+'</span><span class="note-body">'+f[g]+"</span></div");var h=0;$(".notation").each(function(){h++,$(this).prepend('<span class="notes-anchor"><figure>'+h+"</figure></span>")}),metaframe_embed_comments(),$(window).on("resize",function(){$(".notes-tab").removeClass("open"),$(".notes-anchor, .notes-tab").unbind("click"),$(window).width()>700?($(".notes").css({right:"-330px"}),$(".notes-tab").css({right:"10px"}),$(".notes").removeClass("bottom"),a()):($(".notes").css({bottom:"-330px"}),$(".notes-tab").css({bottom:"10px"}),$(".notes").addClass("bottom"),b())}),$(window).width()>700?a():($(".notes").addClass("bottom"),b()),$("#noteBox").click(function(){$(".notes-anchor").toggle()}),0===$(".note-body").size()&&$(".notes").append("<p>There are no notes yet. I guess you can go home early today!</p>"),$(".Scrollable").on("DOMMouseScroll mousewheel",function(a){var b=$(this),c=this.scrollTop,d=this.scrollHeight,e=b.height(),f=a.originalEvent.wheelDelta,g=f>0,h=function(){return a.stopPropagation(),a.preventDefault(),a.returnValue=!1,!1};return!g&&-f>d-e-c?(b.scrollTop(d),h()):g&&f>c?(b.scrollTop(0),h()):void 0})});